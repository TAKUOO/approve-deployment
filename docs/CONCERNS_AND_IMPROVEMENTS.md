# AutoRelease - 懸念点と改善施策

## 概要

このドキュメントでは、AutoReleaseサービスの現状における懸念点と、それに対するシンプルな改善施策をまとめています。

---

## 🔴 セキュリティに関する懸念

### 1. 承認トークンの管理

| 懸念点 | 詳細 |
|--------|------|
| 承認URLの漏洩リスク | 承認URLが第三者に漏れると、意図しないデプロイが実行される可能性がある |
| トークンの有効期限 | 長期間有効な場合、漏洩時のリスクが高まる |
| ワンタイム使用の徹底 | 承認後のトークン無効化が確実に行われているか |

**改善施策:**

| 施策 | 実装難易度 | 優先度 |
|------|------------|--------|
| 承認トークンの有効期限を24時間→6時間に短縮 | ⭐ | 高 |
| 承認後に即座にトークンを無効化（既存実装の確認・強化） | ⭐ | 高 |
| 承認者IP、User-Agentを`deploy_logs`テーブルに記録 | ⭐⭐ | 中 |

### 2. SSH秘密鍵の取り扱い

| 懸念点 | 詳細 |
|--------|------|
| 鍵の管理 | GitHub Secretsに保存されるが、ユーザーが適切に管理しているか確認できない |
| ローテーション | 秘密鍵のローテーションポリシーがない |

**改善施策:**

| 施策 | 実装難易度 | 優先度 |
|------|------------|--------|
| ドキュメントに鍵のローテーション推奨期間を記載 | ⭐ | 低 |
| SSH鍵の設定確認機能（接続テスト）の追加 | ⭐⭐⭐ | 低 |

### 3. 権限管理

| 懸念点 | 詳細 |
|--------|------|
| アクセス制御 | GitHub組織/リポジトリへのアクセス権限の細かい制御が不十分 |
| 監査ログ | 誰が承認したかの監査ログが限定的 |

**改善施策:**

| 施策 | 実装難易度 | 優先度 |
|------|------------|--------|
| プロジェクトごとに承認可能なメールドメインを設定可能に | ⭐⭐ | 中 |
| 承認履歴の詳細ログ（IP、時刻、ブラウザ情報）を保存 | ⭐⭐ | 中 |

---

## 🟠 運用・インフラに関する懸念

### 1. 依存サービス

| 懸念点 | 詳細 |
|--------|------|
| GitHub API依存 | GitHub障害時にサービス全体が停止する |
| Railway依存 | マイグレーション問題など、プラットフォーム固有の課題がある |

**改善施策:**

| 施策 | 実装難易度 | 優先度 |
|------|------------|--------|
| APIエラー時にリトライ機能（3回、指数バックオフ）を追加 | ⭐⭐ | 高 |
| GitHub API障害時のフォールバック表示（キャッシュデータ表示） | ⭐⭐ | 中 |

### 2. スケーラビリティ

| 懸念点 | 詳細 |
|--------|------|
| パフォーマンス | 大量のプロジェクト/デプロイログでのパフォーマンス低下 |
| レート制限 | GitHub APIのレート制限（1時間あたり5,000リクエスト） |

**改善施策:**

| 施策 | 実装難易度 | 優先度 |
|------|------------|--------|
| GitHub APIレスポンスを5分間キャッシュ | ⭐⭐ | 高 |
| デプロイログのページネーション最適化 | ⭐⭐ | 中 |
| 古いデプロイログの自動アーカイブ（90日以上） | ⭐⭐ | 低 |

### 3. データベース

| 懸念点 | 詳細 |
|--------|------|
| マイグレーション | 重複カラム問題など、マイグレーションの複雑さ |
| バックアップ | バックアップ/リカバリー戦略が不明確 |

**改善施策:**

| 施策 | 実装難易度 | 優先度 |
|------|------------|--------|
| 今後のマイグレーションで`Schema::hasColumn()`チェックを標準化 | ⭐ | 高 |
| Railway側で日次自動バックアップを設定 | ⭐ | 高 |

---

## 🟡 機能的な懸念

### 1. ロールバック機能

| 懸念点 | 詳細 |
|--------|------|
| 復旧手段なし | デプロイ失敗時や問題発生時の復旧手段が提供されていない |
| 手動対応 | 前バージョンへの切り戻しはユーザーが手動で行う必要がある |

**改善施策:**

| 施策 | 実装難易度 | 優先度 |
|------|------------|--------|
| 前回成功したデプロイへのロールバックボタン追加 | ⭐⭐⭐ | 高 |
| ロールバック用のGitHub Actionsワークフローテンプレート提供 | ⭐⭐ | 中 |

### 2. 通知機能

| 懸念点 | 詳細 |
|--------|------|
| 通知なし | デプロイ完了/失敗時のSlack/メール通知がない |
| クライアント通知 | クライアントへの自動通知機能がない |

**改善施策:**

| 施策 | 実装難易度 | 優先度 |
|------|------------|--------|
| 承認URL発行時にメール送信 | ⭐⭐ | 高 |
| デプロイ完了/失敗時にメール送信 | ⭐⭐ | 高 |
| Slack Webhook連携（オプション） | ⭐⭐ | 中 |

### 3. ブランチ管理

| 懸念点 | 詳細 |
|--------|------|
| 大量ブランチ | 大量のブランチがある場合の取得問題 |
| ブランチ保護 | ブランチ保護ルールとの連携がない |

**改善施策:**

| 施策 | 実装難易度 | 優先度 |
|------|------------|--------|
| `main`/`master`を直接API指定で取得 | ✅ 実装済み | - |
| ブランチ名の自由入力を許可（datalist併用） | ✅ 実装済み | - |

### 4. デプロイ履歴

| 懸念点 | 詳細 |
|--------|------|
| 履歴確認 | 過去のデプロイ結果を簡単に確認できない |

**改善施策:**

| 施策 | 実装難易度 | 優先度 |
|------|------------|--------|
| 過去10件のデプロイ結果を一覧表示 | ⭐⭐ | 中 |
| デプロイ履歴のCSVエクスポート | ⭐⭐ | 低 |

---

## 🔵 ユーザー体験に関する懸念

### 1. パフォーマンス

| 懸念点 | 詳細 |
|--------|------|
| モーダル遅延 | モーダル表示のタイムラグ |
| 画面遷移 | GitHub API同期による画面遷移の遅さ |

**改善施策:**

| 施策 | 実装難易度 | 優先度 |
|------|------------|--------|
| プロジェクトデータを事前にpropsで渡す | ✅ 実装済み | - |
| GitHub API同期を非同期化 | ✅ 実装済み | - |
| ローディングスケルトンの表示 | ⭐ | 低 |

### 2. エラーハンドリング

| 懸念点 | 詳細 |
|--------|------|
| エラーメッセージ | エラーメッセージが技術的で分かりにくい |
| 解決策なし | 具体的な解決策が提示されない |

**改善施策:**

| 施策 | 実装難易度 | 優先度 |
|------|------------|--------|
| よくあるエラーに日本語の解決策を表示 | ⭐⭐ | 高 |
| エラーコードと対応表をドキュメントに追加 | ⭐ | 中 |

### 3. 初期設定

| 懸念点 | 詳細 |
|--------|------|
| 複雑さ | SSH設定、GitHub Secrets、Webhook設定など初期設定が複雑 |
| トラブルシューティング | トラブルシューティングの情報が限定的 |

**改善施策:**

| 施策 | 実装難易度 | 優先度 |
|------|------------|--------|
| セットアップウィザード（ステップバイステップ） | ⭐⭐⭐ | 中 |
| 設定チェック機能（SSH接続テスト等） | ⭐⭐⭐ | 中 |
| FAQセクションの追加 | ⭐ | 低 |

---

## 🟣 ビジネス・法的懸念

### 1. 責任範囲

| 懸念点 | 詳細 |
|--------|------|
| 損害責任 | デプロイ失敗による損害の責任所在が不明確 |
| SLA | サービスレベル契約の定義がない |

**改善施策:**

| 施策 | 実装難易度 | 優先度 |
|------|------------|--------|
| 利用規約に免責事項を明記 | ⭐ | 高 |
| SLAの定義と公開（目標稼働率99.5%等） | ⭐ | 中 |

### 2. データ保持

| 懸念点 | 詳細 |
|--------|------|
| 保持期間 | デプロイログの保持期間が不明確 |
| プライバシー | GDPR等のプライバシー規制への対応 |

**改善施策:**

| 施策 | 実装難易度 | 優先度 |
|------|------------|--------|
| データ保持ポリシーの策定と公開 | ⭐ | 中 |
| プライバシーポリシーの整備 | ⭐ | 中 |
| ユーザーデータ削除機能の提供 | ⭐⭐ | 低 |

---

## 📋 実装ロードマップ

### Phase 1（1-2週間）- 即効性のある改善

| # | 施策 | 難易度 |
|---|------|--------|
| 1 | 承認トークン有効期限を6時間に短縮 | ⭐ |
| 2 | 承認者IPとUser-Agentをログに記録 | ⭐⭐ |
| 3 | GitHub APIリトライ機能追加 | ⭐⭐ |
| 4 | よくあるエラーの日本語メッセージ追加 | ⭐⭐ |
| 5 | マイグレーションの`hasColumn`チェック標準化 | ⭐ |

### Phase 2（2-4週間）- 運用効率化

| # | 施策 | 難易度 |
|---|------|--------|
| 6 | メール通知機能（承認URL発行時） | ⭐⭐ |
| 7 | メール通知機能（デプロイ完了時） | ⭐⭐ |
| 8 | GitHub APIレスポンスのキャッシュ | ⭐⭐ |
| 9 | デプロイ履歴一覧の表示強化 | ⭐⭐ |
| 10 | Slack Webhook連携（オプション） | ⭐⭐ |

### Phase 3（1-2ヶ月）- 高度な機能

| # | 施策 | 難易度 |
|---|------|--------|
| 11 | ロールバック機能 | ⭐⭐⭐ |

| 12 | セットアップウィザード | ⭐⭐⭐ |
| 13 | SSH接続テスト機能 | ⭐⭐⭐ |
| 14 | リアルタイムログ表示 | ⭐⭐⭐ |

---

## 🛠️ コード例

### 1. 承認トークン有効期限の短縮

```php
// config/autorelease.php
return [
    'approve_token_expires_hours' => env('APPROVE_TOKEN_EXPIRES_HOURS', 6),
];

// ProjectController.php
$expiresAt = now()->addHours(config('autorelease.approve_token_expires_hours'));
```

### 2. 承認者情報のログ記録

```php
// マイグレーション
Schema::table('deploy_logs', function (Blueprint $table) {
    $table->string('approved_ip')->nullable();
    $table->string('approved_user_agent')->nullable();
});

// ApproveController.php
$deployLog->update([
    'approved_ip' => $request->ip(),
    'approved_user_agent' => substr($request->userAgent(), 0, 255),
    'approved_at' => now(),
]);
```

### 3. GitHub APIリトライ機能

```php
// app/Services/GitHubService.php
private function requestWithRetry(string $url, string $method = 'GET', int $retries = 3)
{
    $lastException = null;
    
    for ($i = 0; $i < $retries; $i++) {
        try {
            $response = Http::withToken($this->token)
                ->timeout(30)
                ->$method($url);
            
            if ($response->successful()) {
                return $response;
            }
            
            // レート制限の場合は待機
            if ($response->status() === 403 && $response->header('X-RateLimit-Remaining') === '0') {
                $resetTime = $response->header('X-RateLimit-Reset');
                $waitSeconds = max(1, $resetTime - time());
                sleep(min($waitSeconds, 60));
                continue;
            }
            
        } catch (\Exception $e) {
            $lastException = $e;
        }
        
        // 指数バックオフ（1秒、2秒、4秒）
        sleep(pow(2, $i));
    }
    
    throw $lastException ?? new \Exception('GitHub API request failed after retries');
}
```

### 4. エラーメッセージの改善

```php
// resources/lang/ja/errors.php
return [
    'github' => [
        'no_ref_found' => 'ブランチ「:branch」が見つかりません。リポジトリに指定したブランチが存在するか確認してください。',
        'permission_denied' => 'SSH接続に失敗しました。GitHub SecretsのSSH_PRIVATE_KEYが正しく設定されているか確認してください。',
        'rate_limit' => 'GitHub APIの制限に達しました。:minutes分後に再試行してください。',
        'workflow_not_found' => 'ワークフロー「:workflow」が見つかりません。.github/workflowsディレクトリを確認してください。',
    ],
];

// 使用例
return back()->withErrors([
    'error' => __('errors.github.no_ref_found', ['branch' => $branch])
]);
```

### 5. メール通知機能

```php
// app/Mail/ApprovalUrlNotification.php
class ApprovalUrlNotification extends Mailable
{
    public function __construct(
        public Project $project,
        public string $approvalUrl
    ) {}

    public function content(): Content
    {
        return new Content(
            view: 'emails.approval-url',
            with: [
                'projectName' => $this->project->name,
                'approvalUrl' => $this->approvalUrl,
                'expiresAt' => $this->project->approve_token_expires_at,
            ],
        );
    }
}

// 使用例
Mail::to($clientEmail)->send(new ApprovalUrlNotification($project, $approvalUrl));
```

---

## 📊 優先度マトリクス

```
        高影響
           │
    ┌──────┼──────┐
    │ロール│通知  │
    │バック│機能  │
高  │      │      │
緊  ├──────┼──────┤
急  │トーク│API   │
度  │ン短縮│キャッシュ│
    │監査  │      │
    │ログ  │      │
    └──────┼──────┘
           │
        低影響
```

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-08 | 初版作成 |


